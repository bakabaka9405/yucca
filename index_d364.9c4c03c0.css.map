{"version":3,"sources":["/src/style.css","/src/components/LoadingOverlay.vue","/src/components/PointerLockPrompt.vue","/src/components/SceneTreePanel.vue","/src/components/ControlPanel.vue","/src/components/Viewer.vue"],"sourcesContent":["body {\n  margin: 0;\n}","<script setup lang=\"ts\">\nimport { NProgress, NSpin, NText } from 'naive-ui';\n\ndefineProps<{\n    isLoading: boolean;\n    progress: number;\n}>();\n</script>\n\n<template>\n    <Transition name=\"fade\">\n        <div v-if=\"isLoading\" class=\"loading-overlay\">\n            <div class=\"loading-content\">\n                <n-spin size=\"large\" />\n                <n-text class=\"loading-text\">æ¨¡å‹åŠ è½½ä¸­...</n-text>\n                <n-progress type=\"line\" :percentage=\"progress\" :show-indicator=\"true\" :height=\"8\" :border-radius=\"4\"\n                    indicator-placement=\"outside\" style=\"width: 280px; margin-top: 16px;\" />\n            </div>\n        </div>\n    </Transition>\n</template>\n\n<style scoped>\n.loading-overlay {\n    position: fixed;\n    inset: 0;\n    z-index: 9999;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    background: rgba(0, 0, 0, 0.6);\n    backdrop-filter: blur(10px);\n}\n\n.loading-content {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    gap: 12px;\n}\n\n.loading-text {\n    font-size: 18px;\n    color: #fff;\n    margin-top: 8px;\n}\n\n.fade-enter-active,\n.fade-leave-active {\n    transition: opacity 0.4s ease;\n}\n\n.fade-enter-from,\n.fade-leave-to {\n    opacity: 0;\n}\n</style>\n","<script setup lang=\"ts\">\nimport { NCard, NText, NSpace, NButton } from 'naive-ui';\nimport { computed } from 'vue';\n\nconst props = defineProps<{\n    visible: boolean;\n    mode: string;\n}>();\n\nconst emit = defineEmits<{\n    enterPointerLock: [];\n}>();\n\nconst title = computed(() => props.mode === 'fly' ? 'è‡ªç”±é£è¡Œè§†è§’' : 'ç¬¬ä¸‰äººç§°è§†è§’');\n</script>\n\n<template>\n    <n-card v-show=\"visible\" class=\"controls-overlay\" :bordered=\"false\" size=\"small\" :title=\"title\">\n        <n-text depth=\"3\">\n            <template v-if=\"mode === 'fly'\">\n                ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä»¥é”å®šé¼ æ ‡ï¼Œä½¿ç”¨ <n-text strong>W A S D</n-text> ç§»åŠ¨ï¼Œ<n-text strong>ç©ºæ ¼</n-text> ä¸Šå‡ï¼Œ<n-text\n                    strong>Shift</n-text>\n                ä¸‹é™ï¼Œé¼ æ ‡æ—‹è½¬æ–¹å‘ã€‚\n            </template>\n            <template v-else>\n                ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä»¥é”å®šé¼ æ ‡ï¼Œä½¿ç”¨ <n-text strong>W A S D</n-text> ç§»åŠ¨ï¼Œé¼ æ ‡æ—‹è½¬è§†è§’ã€‚\n            </template>\n        </n-text>\n        <n-space vertical style=\"margin-top: 12px;\">\n            <n-button type=\"primary\" @click=\"emit('enterPointerLock')\" block>å¼€å§‹ä½“éªŒ</n-button>\n            <n-text depth=\"3\" style=\"font-size: 12px;\">æŒ‰ <n-text code>Esc</n-text> å¯é€€å‡ºé”å®š</n-text>\n        </n-space>\n    </n-card>\n</template>\n\n<style scoped>\n.controls-overlay {\n    position: absolute;\n    left: 16px;\n    top: 16px;\n    max-width: 320px;\n    pointer-events: auto;\n    backdrop-filter: blur(10px);\n}\n</style>\n","<script setup lang=\"ts\">\nimport { ref, watch } from 'vue';\nimport { NSpace, NText, NSlider, NTree, type TreeOption } from 'naive-ui';\nimport { storeToRefs } from 'pinia';\nimport { useSceneStore } from '../stores/sceneStore';\nimport type * as THREE from 'three/webgpu';\n\nexport interface SceneTreeNode extends TreeOption {\n    key: string;\n    label: string;\n    object3D: THREE.Object3D;\n    children?: SceneTreeNode[];\n}\n\nconst store = useSceneStore();\nconst { modelRoot, movementMode } = storeToRefs(store);\n\nconst sceneTreeData = ref<SceneTreeNode[]>([]);\nconst checkedKeys = ref<string[]>([]);\nconst treeMaxDepth = ref(4);\n\nconst buildSceneTree = (object: THREE.Object3D, parentKey = '', currentDepth = 1): SceneTreeNode => {\n    const key = parentKey ? `${parentKey}-${object.id}` : `${object.id}`;\n    const node: SceneTreeNode = {\n        key,\n        label: object.name || `${object.type} #${object.id}`,\n        object3D: object,\n    };\n\n    if (object.children.length > 0 && currentDepth < treeMaxDepth.value) {\n        node.children = object.children.map(child => buildSceneTree(child, key, currentDepth + 1));\n    }\n\n    return node;\n};\n\nconst collectAllKeys = (nodes: SceneTreeNode[]): string[] => {\n    const keys: string[] = [];\n    const traverse = (nodeList: SceneTreeNode[]) => {\n        for (const node of nodeList) {\n            keys.push(node.key);\n            if (node.children) {\n                traverse(node.children);\n            }\n        }\n    };\n    traverse(nodes);\n    return keys;\n};\n\nconst rebuildSceneTree = () => {\n    if (modelRoot.value) {\n        const treeNode = buildSceneTree(modelRoot.value);\n        sceneTreeData.value = [treeNode];\n        checkedKeys.value = collectAllKeys(sceneTreeData.value);\n    }\n};\n\nconst handleCheckedKeysUpdate = (\n    keys: string[],\n    _options: Array<TreeOption | null>,\n    meta: { node: TreeOption | null, action: 'check' | 'uncheck' }\n) => {\n    const node = meta.node as SceneTreeNode | null;\n    if (node) {\n        node.object3D.visible = meta.action === 'check';\n    }\n    checkedKeys.value = keys;\n};\n\nfunction visitNode(path: string[]): SceneTreeNode | null {\n    let cur = sceneTreeData.value;\n    for (const name of path) {\n        const next = cur.find(node => node.object3D.name === name);\n        if (!next) return null;\n        if (name === path[path.length - 1]) {\n            return next;\n        }\n        cur = next.children || [];\n    }\n    return null;\n}\n\nwatch(modelRoot, (newRoot) => {\n    if (newRoot) {\n        rebuildSceneTree();\n    }\n}, { immediate: true });\n\nwatch(treeMaxDepth, () => {\n    rebuildSceneTree();\n});\n\nwatch(movementMode, (mode) => {\n    const isTop = mode === 'topView';\n    const node = visitNode(['Scene', 'Scene_Collection', 'Ceiling']);\n    if (node) {\n        node.object3D.visible = !isTop;\n        if (!isTop) {\n            if (!checkedKeys.value.includes(node.key)) {\n                checkedKeys.value.push(node.key);\n            }\n        } else {\n            checkedKeys.value = checkedKeys.value.filter(k => k !== node.key);\n        }\n    }\n});\n</script>\n\n<template>\n    <n-text depth=\"3\">å‹¾é€‰/å–æ¶ˆå‹¾é€‰ä»¥æ˜¾ç¤º/éšè—æ¨¡å‹å±‚çº§ä¸­çš„å¯¹è±¡ã€‚</n-text>\n\n    <!-- æœ€å¤§æ·±åº¦è®¾ç½® -->\n    <n-space vertical size=\"small\" style=\"margin-top: 12px; margin-bottom: 12px;\">\n        <n-space justify=\"space-between\" style=\"width: 100%;\">\n            <n-text depth=\"2\" style=\"font-size: 12px;\">æ˜¾ç¤ºæ·±åº¦</n-text>\n            <n-text>{{ treeMaxDepth }} å±‚</n-text>\n        </n-space>\n        <n-slider v-model:value=\"treeMaxDepth\" :min=\"1\" :max=\"10\" :step=\"1\" />\n    </n-space>\n\n    <div class=\"scene-tree-container\">\n        <n-tree :data=\"sceneTreeData\" :checked-keys=\"checkedKeys\" @update:checked-keys=\"handleCheckedKeysUpdate\"\n            checkable selectable block-line expand-on-click default-expand-all style=\"font-size: 12px\" />\n    </div>\n</template>\n\n<style scoped>\n.scene-tree-container {\n    margin-top: 12px;\n}\n</style>\n","<script setup lang=\"ts\">\nimport { NCard, NSpace, NText, NSwitch, NTabs, NTabPane } from 'naive-ui';\nimport { storeToRefs } from 'pinia';\nimport { useSceneStore } from '../stores/sceneStore';\nimport SceneParamsPanel from './SceneParamsPanel.vue';\nimport SceneTreePanel from './SceneTreePanel.vue';\n\nconst store = useSceneStore();\nconst { isDarkMode } = storeToRefs(store);\n</script>\n\n<template>\n    <n-card class=\"param-panel\" :bordered=\"false\" size=\"small\">\n        <template #header>\n            <n-space align=\"center\" justify=\"space-between\" style=\"margin: 0; width: 100%;\">\n                <n-text strong>æ§åˆ¶é¢æ¿</n-text>\n                <n-switch v-model:value=\"isDarkMode\" size=\"small\">\n                    <template #checked>ğŸŒ™</template>\n                    <template #unchecked>â˜€ï¸</template>\n                </n-switch>\n            </n-space>\n        </template>\n\n        <n-tabs type=\"line\" animated>\n            <!-- åœºæ™¯è°ƒå‚é€‰é¡¹å¡ -->\n            <n-tab-pane name=\"params\" tab=\"åœºæ™¯è°ƒå‚\">\n                <SceneParamsPanel />\n            </n-tab-pane>\n\n            <!-- æ¨¡å‹å±‚çº§é€‰é¡¹å¡ -->\n            <n-tab-pane name=\"hierarchy\" tab=\"æ¨¡å‹å±‚çº§\" display-directive=\"show\">\n                <SceneTreePanel />\n            </n-tab-pane>\n        </n-tabs>\n    </n-card>\n</template>\n\n<style scoped>\n.param-panel {\n    position: absolute;\n    right: 16px;\n    top: 16px;\n    width: 320px;\n    max-height: calc(100vh - 32px);\n    overflow-y: auto;\n    pointer-events: auto;\n    backdrop-filter: blur(14px);\n}\n</style>\n","<script setup lang=\"ts\">\nimport { onMounted, onBeforeUnmount, ref, computed, watch } from 'vue';\nimport viewer from '../engine/Viewer';\nimport { NConfigProvider, darkTheme, type GlobalTheme } from 'naive-ui';\nimport { storeToRefs } from 'pinia';\nimport { useSceneStore } from '../stores/sceneStore';\nimport LoadingOverlay from './LoadingOverlay.vue';\nimport PointerLockPrompt from './PointerLockPrompt.vue';\nimport ControlPanel from './ControlPanel.vue';\nimport { initViewerScene } from '../engine/ViewerInit';\n\nconst store = useSceneStore();\nconst {\n    isLoading,\n    loadingProgress,\n    isDarkMode,\n    movementMode,\n    isEditingPosition,\n    isEditingDirection,\n    playerPosition,\n    isEditingPlayerPosition,\n    showInteractionPrompt,\n    interactionText,\n} = storeToRefs(store);\n\nawait initViewerScene();\n\n// ä¸»é¢˜\nconst theme = computed<GlobalTheme | null>(() => isDarkMode.value ? darkTheme : null);\n\nconst isLocked = ref(false);\n\nconst enterPointerLock = () => {\n    if (movementMode.value === 'fly' || movementMode.value === 'thirdPerson') {\n        viewer.lockPointer();\n    }\n};\n\nconst syncCameraState = () => {\n    if (!isEditingPosition.value) {\n        store.updateCameraPosition(viewer.camera.position);\n    }\n    if (!isEditingDirection.value) {\n        store.updateCameraDirection(viewer.getCameraDirection());\n    }\n    if (movementMode.value === 'thirdPerson' && !isEditingPlayerPosition.value && viewer.character?.mesh) {\n        store.updatePlayerPosition(viewer.character.mesh.position);\n    }\n};\n\nwatch(playerPosition, (val) => {\n    if (viewer.character?.mesh) {\n        viewer.character.mesh.position.set(val.x, val.y, val.z);\n    }\n}, { deep: true });\n\n\nconst shouldShowPrompt = computed(() => (movementMode.value === 'fly' || movementMode.value === 'thirdPerson') && !isLocked.value);\n\nlet cameraSyncInterval: ReturnType<typeof setInterval> | null = null;\n\nconst onPointerLockChange = () => {\n    isLocked.value = document.pointerLockElement === viewer.renderer.domElement;\n};\n\nonMounted(() => {\n    cameraSyncInterval = setInterval(syncCameraState, 200);\n    document.addEventListener('pointerlockchange', onPointerLockChange);\n});\n\nonBeforeUnmount(() => {\n    if (cameraSyncInterval !== null) {\n        clearInterval(cameraSyncInterval);\n        cameraSyncInterval = null;\n    }\n    document.removeEventListener('pointerlockchange', onPointerLockChange);\n});\n\n</script>\n\n<template>\n    <n-config-provider :theme=\"theme\">\n        <LoadingOverlay :isLoading=\"isLoading\" :progress=\"loadingProgress\" />\n\n        <div class=\"ui-layer\">\n            <PointerLockPrompt :visible=\"shouldShowPrompt\" :mode=\"movementMode\" @enterPointerLock=\"enterPointerLock\" />\n            \n            <div v-if=\"showInteractionPrompt\" class=\"interaction-prompt\">\n                {{ interactionText }}\n            </div>\n\n            <ControlPanel />\n        </div>\n    </n-config-provider>\n</template>\n\n<style scoped>\n.ui-layer {\n    position: fixed;\n    inset: 0;\n    pointer-events: none;\n}\n\n.interaction-prompt {\n    position: absolute;\n    top: 60%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    background: rgba(0, 0, 0, 0.7);\n    color: white;\n    padding: 10px 20px;\n    border-radius: 8px;\n    font-size: 16px;\n    pointer-events: none;\n    z-index: 100;\n}\n</style>\n"],"names":[],"mappings":"AAAA;ACuBA;ACaA;AC4FA;AC1FA;AC2DA"}