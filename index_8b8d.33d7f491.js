(function(_){var filename = ((function(){var _documentCurrentScript = typeof document !== "undefined" ? document.currentScript : null;return typeof document === "undefined" ? require("url").pathToFileURL(__filename).href : _documentCurrentScript && _documentCurrentScript.src || new URL("index_8b8d.js", document.baseURI).href})());for(var r in _){_[r].__farm_resource_pot__=filename;window['f1d71b9dd14324d7340d3311efaf8136'].__farm_module_system__.register(r,_[r])}})({"4735cb57":function e(e,t,a,l){e._m(t),a("2d08c2e5"),a("a3876e70");var u=a("9aaf3498"),n=a("9aaf3498"),r=a("1f6a8afd"),f=a("0e70da6a"),d=a("f247f526");t.default=u.defineComponent({__name:"PostProcessPanel",setup(e){var t=d.useSceneStore(),a=f.storeToRefs(t),l=a.gtaoEnabled,u=a.gtaoSamples,i=a.gtaoDistanceExponent,o=a.gtaoDistanceFallOff,s=a.gtaoRadius,N=a.gtaoScale,c=a.gtaoThickness,x=a.gtaoAoOnly;return(e,t)=>(n.openBlock(),n.createBlock(n.unref(r.NSpace),{vertical:"",size:"large"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"2",style:{"font-size":"12px"}},{default:n.withCtx(()=>[...t[8]||(t[8]=[n.createTextVNode("GTAO",-1)])]),_:1}),n.createVNode(n.unref(r.NSpace),{align:"center"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSwitch),{value:n.unref(l),"onUpdate:value":t[0]||(t[0]=e=>n.isRef(l)?l.value=e:null)},null,8,["value"]),n.createVNode(n.unref(r.NText),null,{default:n.withCtx(()=>[...t[9]||(t[9]=[n.createTextVNode("启用 GTAO",-1)])]),_:1})]),_:1}),n.createVNode(n.unref(r.NSpace),{align:"center"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSwitch),{value:n.unref(x),"onUpdate:value":t[1]||(t[1]=e=>n.isRef(x)?x.value=e:null),disabled:!n.unref(l)},null,8,["value","disabled"]),n.createVNode(n.unref(r.NText),null,{default:n.withCtx(()=>[...t[10]||(t[10]=[n.createTextVNode("仅显示 AO",-1)])]),_:1})]),_:1}),n.createVNode(n.unref(r.NGrid),{cols:2,"x-gap":8,"y-gap":8},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NGi),null,{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"3",style:{"font-size":"11px"}},{default:n.withCtx(()=>[...t[11]||(t[11]=[n.createTextVNode("Samples",-1)])]),_:1}),n.createVNode(n.unref(r.NInputNumber),{value:n.unref(u),"onUpdate:value":t[2]||(t[2]=e=>n.isRef(u)?u.value=e:null),size:"small",min:4,max:32,step:1,"show-button":!1},null,8,["value"])]),_:1})]),_:1}),n.createVNode(n.unref(r.NGi),null,{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"3",style:{"font-size":"11px"}},{default:n.withCtx(()=>[...t[12]||(t[12]=[n.createTextVNode("Radius",-1)])]),_:1}),n.createVNode(n.unref(r.NInputNumber),{value:n.unref(s),"onUpdate:value":t[3]||(t[3]=e=>n.isRef(s)?s.value=e:null),size:"small",min:.01,max:2,step:.01,"show-button":!1},null,8,["value"])]),_:1})]),_:1}),n.createVNode(n.unref(r.NGi),null,{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"3",style:{"font-size":"11px"}},{default:n.withCtx(()=>[...t[13]||(t[13]=[n.createTextVNode("Distance Exp",-1)])]),_:1}),n.createVNode(n.unref(r.NInputNumber),{value:n.unref(i),"onUpdate:value":t[4]||(t[4]=e=>n.isRef(i)?i.value=e:null),size:"small",min:1,max:4,step:.1,"show-button":!1},null,8,["value"])]),_:1})]),_:1}),n.createVNode(n.unref(r.NGi),null,{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"3",style:{"font-size":"11px"}},{default:n.withCtx(()=>[...t[14]||(t[14]=[n.createTextVNode("Distance Falloff",-1)])]),_:1}),n.createVNode(n.unref(r.NInputNumber),{value:n.unref(o),"onUpdate:value":t[5]||(t[5]=e=>n.isRef(o)?o.value=e:null),size:"small",min:.01,max:2,step:.01,"show-button":!1},null,8,["value"])]),_:1})]),_:1}),n.createVNode(n.unref(r.NGi),null,{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"3",style:{"font-size":"11px"}},{default:n.withCtx(()=>[...t[15]||(t[15]=[n.createTextVNode("Scale",-1)])]),_:1}),n.createVNode(n.unref(r.NInputNumber),{value:n.unref(N),"onUpdate:value":t[6]||(t[6]=e=>n.isRef(N)?N.value=e:null),size:"small",min:.01,max:2,step:.01,"show-button":!1},null,8,["value"])]),_:1})]),_:1}),n.createVNode(n.unref(r.NGi),null,{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"3",style:{"font-size":"11px"}},{default:n.withCtx(()=>[...t[16]||(t[16]=[n.createTextVNode("Thickness",-1)])]),_:1}),n.createVNode(n.unref(r.NInputNumber),{value:n.unref(c),"onUpdate:value":t[7]||(t[7]=e=>n.isRef(c)?c.value=e:null),size:"small",min:.01,max:2,step:.01,"show-button":!1},null,8,["value"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}));}});},"5c6f8c17":function e(e,t,i,a){e._m(t),e.o(t,"EnvHeatmapManager",()=>d);var s=i("09efd1d2"),r=i("493f9ad4"),o=e.w(i("3b16918b")),m=i("16fd0772");class d{createDisplayMeshes(e){var t=new o.PlaneGeometry(1,1);t.rotateX(-Math.PI/2),Object.keys(this.layerConfigs).forEach(i=>{var a=this.layerConfigs[i],s=this.textures[i],r=this.params.flipV?m.uv().flipY():m.uv(),d=m.texture(s).sample(r).r,u=m.pow(d.max(0),m.float(this.params.displayGamma)),n=a.baseColor,l=m.mix(n.mul(.25),n,u),h=m.smoothstep(.12,.85,u).mul(this.params.opacity),p=new o.MeshBasicNodeMaterial;p.colorNode=l,p.opacityNode=h,p.transparent=!0,p.side=o.DoubleSide,p.depthWrite=!1,p.polygonOffset=!0,p.polygonOffsetFactor=-2;var c=new o.Mesh(t,p);c.position.y=this.params.y,c.visible=!1,this.displayMeshes[i]=c,e.add(c);}),this.updateDisplayMeshTransform();}update(e){if(this.timeUniform.value=this.timeUniform.value+e,this.activeLayer){var t=this.displayMeshes[this.activeLayer];t&&t.visible&&this.renderer.compute(this.computeNodes[this.activeLayer]);}}setActiveLayer(e){this.activeLayer=e,Object.keys(this.layerConfigs).forEach(t=>{var i=this.displayMeshes[t];i&&(i.visible=e===t);});}setRenderer(e){this.renderer=e;}setXZBoundsFromBox3(e){this.boundsMinUniform.value.set(e.min.x,e.min.z),this.boundsMaxUniform.value.set(e.max.x,e.max.z),this.updateDisplayMeshTransform();}updateDisplayMeshTransform(){var e=Object.values(this.displayMeshes).filter(Boolean);if(0!==e.length){var t=this.boundsMinUniform.value,i=this.boundsMaxUniform.value,a=i.x-t.x,s=i.y-t.y,r=(t.x+i.x)*.5,o=(t.y+i.y)*.5;e.forEach(e=>{e.scale.set(a,1,s),e.position.x=r,e.position.z=o;});}}createComputeNode(e,t){var i=m.Fn(e=>{var t=r._(e,1)[0],i=t.floor().toVar(),a=t.fract().toVar(),s=a.mul(a).mul(m.float(3).sub(a.mul(2))),o=e=>{var t=m.vec2(e.x.add(e.z.mul(37)),e.y.add(e.z.mul(17))),i=m.rand(t),a=m.rand(t.add(m.vec2(19.19,7.17))),s=m.rand(t.add(m.vec2(3.11,11.73)));return m.vec3(i,a,s).mul(2).sub(1).normalize();},d=o(i),u=o(i.add(m.vec3(1,0,0))),n=o(i.add(m.vec3(0,1,0))),l=o(i.add(m.vec3(1,1,0))),h=o(i.add(m.vec3(0,0,1))),p=o(i.add(m.vec3(1,0,1))),c=o(i.add(m.vec3(0,1,1))),v=o(i.add(m.vec3(1,1,1))),f=m.dot(d,a),y=m.dot(u,a.sub(m.vec3(1,0,0))),x=m.dot(n,a.sub(m.vec3(0,1,0))),b=m.dot(l,a.sub(m.vec3(1,1,0))),M=m.dot(h,a.sub(m.vec3(0,0,1))),C=m.dot(p,a.sub(m.vec3(1,0,1))),U=m.dot(c,a.sub(m.vec3(0,1,1))),g=m.dot(v,a.sub(m.vec3(1,1,1))),F=m.mix(f,y,s.x),_=m.mix(x,b,s.x),S=m.mix(M,C,s.x),w=m.mix(U,g,s.x),N=m.mix(F,_,s.y),L=m.mix(S,w,s.y);return m.mix(N,L,s.z).mul(.5).add(.5);}),a=m.Fn(e=>{var t=r._(e,1)[0],a=i(t),s=i(t.mul(2)),o=i(t.mul(4)),m=i(t.mul(8));return a.mul(.5).add(s.mul(.25)).add(o.mul(.125)).add(m.mul(.0625)).div(.9375);});return m.Fn(()=>{var i=m.float(this.params.resolution),s=m.float(this.params.resolution),r=m.instanceIndex.mod(this.params.resolution),o=m.instanceIndex.div(this.params.resolution),d=m.uvec2(r,o),u=r.toVar().toFloat().add(.5).div(i),n=o.toVar().toFloat().add(.5).div(s),l=m.mix(this.boundsMinUniform.x,this.boundsMaxUniform.x,u),h=m.mix(this.boundsMinUniform.y,this.boundsMaxUniform.y,n),p=a(m.vec3(l.mul(m.float(t.noiseScale)),h.mul(m.float(t.noiseScale)),this.timeUniform.mul(m.float(t.timeSpeed))));p=m.pow(p.add(.2).max(0).min(1),m.float(t.curvePow)),m.textureStore(e,d,m.vec4(p,0,0,0));})().compute(this.params.resolution*this.params.resolution);}constructor(e){s._(this,"renderer",void 0),s._(this,"boundsMinUniform",m.uniform(m.vec2(-50,-50))),s._(this,"boundsMaxUniform",m.uniform(m.vec2(50,50))),s._(this,"timeUniform",m.uniform(m.float(0))),s._(this,"params",{resolution:512,flipV:!0,displayGamma:1.25,opacity:.55,y:.45}),s._(this,"textures",void 0),s._(this,"computeNodes",void 0),s._(this,"displayMeshes",{}),s._(this,"activeLayer",null),s._(this,"layerConfigs",{temperature:{layer:"temperature",baseColor:m.vec3(.1,.6,.35),noiseScale:.08,timeSpeed:.15,curvePow:1.2},humidity:{layer:"humidity",baseColor:m.vec3(0,.2,1),noiseScale:.1,timeSpeed:.22,curvePow:1.15},pm25:{layer:"pm25",baseColor:m.vec3(1,1,0),noiseScale:.14,timeSpeed:.35,curvePow:2.6}}),this.renderer=e;var t=()=>{var e=new o.StorageTexture(this.params.resolution,this.params.resolution);return e.type=o.FloatType,e.format=o.RedFormat,e.minFilter=o.LinearFilter,e.magFilter=o.LinearFilter,e;};this.textures={temperature:t(),humidity:t(),pm25:t()},this.computeNodes={temperature:this.createComputeNode(this.textures.temperature,this.layerConfigs.temperature),humidity:this.createComputeNode(this.textures.humidity,this.layerConfigs.humidity),pm25:this.createComputeNode(this.textures.pm25,this.layerConfigs.pm25)};}}},"61fbd776":function e(e,t,a,l){e._m(t),a("2d08c2e5"),a("a3876e70"),a("db38ec0f");var u=a("9aaf3498"),r=a("9aaf3498"),n=a("1f6a8afd"),i=a("0e70da6a"),d=a("f247f526"),f=e.i(a("c879eb01"));t.default=u.defineComponent({__name:"LightingPanel",setup(t){var a=d.useSceneStore(),l=i.storeToRefs(a),u=l.skyboxEnabled,o=l.sunEnabled,c=l.sunColor,N=l.sunIntensity,s=l.sunPosition,x=l.ambientEnabled,v=l.ambientColor,p=l.ambientIntensity,h=l.environmentEnabled,V=l.environmentIntensity,w=l.spotEnabled,C=l.spotColor,_=l.spotIntensity,S=l.spotAngle,m=l.spotPenumbra,T=l.spotDecay,z=l.spotDistance;return(t,a)=>(r.openBlock(),r.createBlock(r.unref(n.NSpace),{vertical:"",size:"large"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{align:"center"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSwitch),{value:r.unref(u),"onUpdate:value":a[0]||(a[0]=e=>r.isRef(u)?u.value=e:null)},null,8,["value"]),r.createVNode(r.unref(n.NText),null,{default:r.withCtx(()=>[...a[17]||(a[17]=[r.createTextVNode("天空盒",-1)])]),_:1})]),_:1})]),_:1}),r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{align:"center"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSwitch),{value:r.unref(o),"onUpdate:value":a[1]||(a[1]=e=>r.isRef(o)?o.value=e:null)},null,8,["value"]),r.createVNode(r.unref(n.NText),null,{default:r.withCtx(()=>[...a[18]||(a[18]=[r.createTextVNode("太阳光",-1)])]),_:1})]),_:1}),r.withDirectives(r.createVNode(r.unref(n.NGrid),{cols:2,"x-gap":8},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[...a[19]||(a[19]=[r.createTextVNode("颜色",-1)])]),_:1}),r.createVNode(r.unref(n.NColorPicker),{value:r.unref(c),"onUpdate:value":a[2]||(a[2]=e=>r.isRef(c)?c.value=e:null),"show-alpha":!1,size:"small"},null,8,["value"])]),_:1})]),_:1}),r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[r.createTextVNode("亮度 "+r.toDisplayString(r.unref(N).toFixed(1)),1)]),_:1}),r.createVNode(r.unref(n.NSlider),{value:r.unref(N),"onUpdate:value":a[3]||(a[3]=e=>r.isRef(N)?N.value=e:null),min:0,max:10,step:.1},null,8,["value"])]),_:1})]),_:1})]),_:1},512),[[r.vShow,r.unref(o)]]),r.withDirectives(r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[...a[20]||(a[20]=[r.createTextVNode("光源位置",-1)])]),_:1}),r.createVNode(e.f(f),{value:r.unref(s),"onUpdate:value":a[4]||(a[4]=e=>r.isRef(s)?s.value=e:null)},null,8,["value"])]),_:1},512),[[r.vShow,r.unref(o)]])]),_:1}),r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{align:"center"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSwitch),{value:r.unref(x),"onUpdate:value":a[5]||(a[5]=e=>r.isRef(x)?x.value=e:null)},null,8,["value"]),r.createVNode(r.unref(n.NText),null,{default:r.withCtx(()=>[...a[21]||(a[21]=[r.createTextVNode("全局环境光",-1)])]),_:1})]),_:1}),r.withDirectives(r.createVNode(r.unref(n.NGrid),{cols:2,"x-gap":8},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[...a[22]||(a[22]=[r.createTextVNode("颜色",-1)])]),_:1}),r.createVNode(r.unref(n.NColorPicker),{value:r.unref(v),"onUpdate:value":a[6]||(a[6]=e=>r.isRef(v)?v.value=e:null),"show-alpha":!1,size:"small"},null,8,["value"])]),_:1})]),_:1}),r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[r.createTextVNode("亮度 "+r.toDisplayString(r.unref(p).toFixed(1)),1)]),_:1}),r.createVNode(r.unref(n.NSlider),{value:r.unref(p),"onUpdate:value":a[7]||(a[7]=e=>r.isRef(p)?p.value=e:null),min:0,max:5,step:.1},null,8,["value"])]),_:1})]),_:1})]),_:1},512),[[r.vShow,r.unref(x)]])]),_:1}),r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{align:"center"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSwitch),{value:r.unref(h),"onUpdate:value":a[8]||(a[8]=e=>r.isRef(h)?h.value=e:null)},null,8,["value"]),r.createVNode(r.unref(n.NText),null,{default:r.withCtx(()=>[...a[23]||(a[23]=[r.createTextVNode("环境光照 (RoomEnvironment)",-1)])]),_:1})]),_:1}),r.withDirectives(r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[r.createTextVNode("强度 "+r.toDisplayString(r.unref(V).toFixed(1)),1)]),_:1}),r.createVNode(r.unref(n.NSlider),{value:r.unref(V),"onUpdate:value":a[9]||(a[9]=e=>r.isRef(V)?V.value=e:null),min:0,max:5,step:.1},null,8,["value"])]),_:1},512),[[r.vShow,r.unref(h)]])]),_:1}),r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{align:"center"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSwitch),{value:r.unref(w),"onUpdate:value":a[10]||(a[10]=e=>r.isRef(w)?w.value=e:null)},null,8,["value"]),r.createVNode(r.unref(n.NText),null,{default:r.withCtx(()=>[...a[24]||(a[24]=[r.createTextVNode("摄像机聚光灯",-1)])]),_:1})]),_:1}),r.withDirectives(r.createVNode(r.unref(n.NGrid),{cols:2,"x-gap":8},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[...a[25]||(a[25]=[r.createTextVNode("颜色",-1)])]),_:1}),r.createVNode(r.unref(n.NColorPicker),{value:r.unref(C),"onUpdate:value":a[11]||(a[11]=e=>r.isRef(C)?C.value=e:null),"show-alpha":!1,size:"small"},null,8,["value"])]),_:1})]),_:1}),r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[r.createTextVNode("亮度 "+r.toDisplayString(r.unref(_).toFixed(1)),1)]),_:1}),r.createVNode(r.unref(n.NSlider),{value:r.unref(_),"onUpdate:value":a[12]||(a[12]=e=>r.isRef(_)?_.value=e:null),min:0,max:100,step:.1},null,8,["value"])]),_:1})]),_:1})]),_:1},512),[[r.vShow,r.unref(w)]]),r.withDirectives(r.createVNode(r.unref(n.NGrid),{cols:2,"x-gap":8},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[r.createTextVNode("锥形角度 "+r.toDisplayString(r.unref(S))+"°",1)]),_:1}),r.createVNode(r.unref(n.NSlider),{value:r.unref(S),"onUpdate:value":a[13]||(a[13]=e=>r.isRef(S)?S.value=e:null),min:5,max:90,step:1},null,8,["value"])]),_:1})]),_:1}),r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[r.createTextVNode("半影 "+r.toDisplayString(r.unref(m).toFixed(2)),1)]),_:1}),r.createVNode(r.unref(n.NSlider),{value:r.unref(m),"onUpdate:value":a[14]||(a[14]=e=>r.isRef(m)?m.value=e:null),min:0,max:1,step:.01},null,8,["value"])]),_:1})]),_:1})]),_:1},512),[[r.vShow,r.unref(w)]]),r.withDirectives(r.createVNode(r.unref(n.NGrid),{cols:2,"x-gap":8},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[r.createTextVNode("衰减 "+r.toDisplayString(r.unref(T).toFixed(1)),1)]),_:1}),r.createVNode(r.unref(n.NSlider),{value:r.unref(T),"onUpdate:value":a[15]||(a[15]=e=>r.isRef(T)?T.value=e:null),min:0,max:5,step:.1},null,8,["value"])]),_:1})]),_:1}),r.createVNode(r.unref(n.NGi),null,{default:r.withCtx(()=>[r.createVNode(r.unref(n.NSpace),{vertical:"",size:"small"},{default:r.withCtx(()=>[r.createVNode(r.unref(n.NText),{depth:"3",style:{"font-size":"11px"}},{default:r.withCtx(()=>[r.createTextVNode("距离 "+r.toDisplayString(r.unref(z)),1)]),_:1}),r.createVNode(r.unref(n.NSlider),{value:r.unref(z),"onUpdate:value":a[16]||(a[16]=e=>r.isRef(z)?z.value=e:null),min:0,max:5e3,step:10},null,8,["value"])]),_:1})]),_:1})]),_:1},512),[[r.vShow,r.unref(w)]])]),_:1})]),_:1}));}});},"67dbd159":function e(e,t,r,n){e._m(t),e.o(t,"Engine",()=>x);var a=r("09efd1d2");r("92de075b"),r("850e6c49"),r("40616381"),r("b25dd2f8"),r("7bccf4aa"),r("2d08c2e5"),r("a3876e70");var s=e.w(r("3b16918b")),o=r("7f2264c7"),i=r("03f4e36a"),h=r("47a20e72"),d=r("69939ce5"),l=r("e9ef43b1"),c=r("e0c628a7"),m=r("3eec3e47"),p=r("7475699d"),u=r("8f363abd"),v=r("ae64a1a9"),g=r("5c6f8c17"),f=r("e00be090"),M=r("f4cd7510"),b=r("c2079dd8"),y=r("96554b2f"),w=r("99602713"),C=e.i(r("26d7988f")),E=r("f247f526"),L=r("6519cad4");s.BufferGeometry.prototype.computeBoundsTree=L.computeBoundsTree,s.BufferGeometry.prototype.disposeBoundsTree=L.disposeBoundsTree,s.Mesh.prototype.raycast=L.acceleratedRaycast;class x{async init(){var t=E.useSceneStore();await e.f(C).init(),e.f(C).onRendererChange(this.handleRendererChange.bind(this));var r=e.f(C).renderer;t.rendererInfo=r.backend.constructor.name.replace("Backend",""),this.setupEnvironment(e.f(C).renderer),this.postProcessing=new p.PostProcessing(e.f(C).renderer,this.scene,e.f(C).camera);var n=new s.CubeTextureLoader;n.setPath("cubeMap/");var a=n.load(w.ASSETS.textures.skybox);this.setSkybox(a);var o=new M.InfiniteGrid;this.scene.add(o),this.scene.add(e.f(C).camera),this.lightManager=new u.LightManager(this.scene,e.f(C).camera),this.heatmapManager=new v.HeatmapManager(e.f(C).renderer),this.heatmapManager.createDisplayMesh(this.scene),this.envHeatmapManager=new g.EnvHeatmapManager(e.f(C).renderer),this.envHeatmapManager.createDisplayMeshes(this.scene),this.modelLoader=new f.ModelLoader(e.f(C).renderer);var i=async()=>{var e=new c.Character;try{this.modelLoader&&(await e.load(this.modelLoader,w.ASSETS.models.char,e=>{e.lengthComputable&&(t.loadingProgress=50+Math.round(e.loaded/e.total*50));}),this.setCharacter(e),t.movementMode="thirdPerson",t.isLoading=!1);}catch(e){console.error("Character loading failed:",e),t.isLoading=!1;}};this.modelLoader.loadGLTF(w.ASSETS.models.home,e=>{e.lengthComputable&&(t.loadingProgress=Math.round(e.loaded/e.total*50));}).then(e=>{if(e.scene.position.set(0,.1,0),this.scene.add(e.scene),t.setModelRoot(e.scene),e.scene.updateMatrixWorld(!0),this.heatmapManager){var r=new s.Box3().setFromObject(e.scene);this.heatmapManager.setXZBoundsFromBox3(r);}if(this.envHeatmapManager){var n=new s.Box3().setFromObject(e.scene);this.envHeatmapManager.setXZBoundsFromBox3(n);}var a=new s.AnimationMixer(e.scene);this.addMixer(a),e.scene.traverse(e=>{e.isMesh&&(e.receiveShadow=!0,e.castShadow=!0,e.name.endsWith("Glass")&&(e.castShadow=!1));});var o=e.scene.getObjectByName("Door");o&&o.children.forEach(t=>{y.doorManager.addDoor(t,e.animations,a);}),b.colliderManager.generateCollider(e.scene,this.scene,e=>{this.setEnvironmentCollider(e);}),b.colliderManager.setVisibility(t.showCollisionBoxes),i();}).catch(e=>{console.error("模型加载失败:",e),t.isLoading=!1;}),this.currentController.enter(),e.f(C).renderer.setAnimationLoop(this.animate);}handleRendererChange(t){Object.values(this.controllers).forEach(e=>{e.setDomElement(t.domElement);}),this.postProcessing=new p.PostProcessing(t,this.scene,e.f(C).camera),this.heatmapManager&&this.heatmapManager.setRenderer(t),this.envHeatmapManager&&this.envHeatmapManager.setRenderer(t),this.modelLoader&&this.modelLoader.updateRenderer(t),this.setupEnvironment(t),t.setAnimationLoop(this.animate);}setupEnvironment(e){var t=new s.PMREMGenerator(e);this.environmentTexture=t.fromScene(new o.RoomEnvironment,.04).texture,this.scene.environment=this.environmentTexture;}addMixer(e){this.mixers.push(e);}setCharacter(e){this.character=e,e.mesh&&(this.scene.add(e.mesh),this.controllers.thirdPerson.setCharacter(e));}async updateGTAO(t){this.gtaoEnabled!==t.enabled&&(this.gtaoEnabled=t.enabled,await e.f(C).recreateRenderer(!t.enabled)),this.postProcessing&&this.postProcessing.update(t);}lockPointer(){"fly"===this.movementMode?this.currentController.setLocked(!0):"thirdPerson"===this.movementMode&&this.currentController.setLocked(!0);}unlockPointer(){"fly"===this.movementMode?this.currentController.setLocked(!1):"thirdPerson"===this.movementMode&&this.currentController.setLocked(!1);}setMovementMode(e){if(this.movementMode!==e){this.currentController.leave(),this.movementMode=e,this.currentController=this.controllers[e],this.currentController.enter(),"topView"!==e&&(this.setHeatmapVisible(!1),this.setEnvHeatmapLayer(null));var t=E.useSceneStore();this.setHeatmapVisible(t.showHeatmap),this.setEnvHeatmapLayer(t.envHeatmapLayer);}}setCameraPosition(t){e.f(C).camera.position.copy(t);}setCameraDirection(t){"orbit"!==this.movementMode&&0!==t.lengthSq()&&e.f(C).camera.lookAt(t.add(e.f(C).camera.position));}getCameraDirection(){var t=new s.Vector3;return e.f(C).camera.getWorldDirection(t),t;}onUpdate(e){return this.updateListeners.add(e),()=>this.updateListeners.delete(e);}dispose(){e.f(C).renderer.setAnimationLoop(null),Object.values(this.controllers).forEach(e=>e.dispose()),e.f(C).dispose();}setEnvironmentEnabled(e){this.scene.environment=e?this.environmentTexture:null;}setEnvironmentIntensity(e){this.scene.environmentIntensity=e;}setEnvironmentCollider(e){this.controllers.thirdPerson.setCollider(e);}setSkybox(e){this.skyboxTexture=e,this.scene.background=e;}setSkyboxEnabled(e){this.scene.background=e?this.skyboxTexture:null;}setHeatmapVisible(e){var t,r;"topView"===this.movementMode?null===(t=this.heatmapManager)||void 0===t||t.setVisible(e):null===(r=this.heatmapManager)||void 0===r||r.setVisible(!1);}setEnvHeatmapLayer(e){var t,r;"topView"===this.movementMode?null===(t=this.envHeatmapManager)||void 0===t||t.setActiveLayer(e):null===(r=this.envHeatmapManager)||void 0===r||r.setActiveLayer(null);}constructor(){a._(this,"scene",void 0),a._(this,"postProcessing",null),a._(this,"gtaoEnabled",!0),a._(this,"controllers",void 0),a._(this,"currentController",void 0),a._(this,"movementMode","fly"),a._(this,"clock",new s.Clock),a._(this,"environmentTexture",null),a._(this,"mixers",[]),a._(this,"skyboxTexture",null),a._(this,"character",null),a._(this,"lightManager",null),a._(this,"heatmapManager",null),a._(this,"envHeatmapManager",null),a._(this,"modelLoader",null),a._(this,"updateListeners",new Set),a._(this,"animate",()=>{var t,r=this.clock.getDelta();this.mixers.forEach(e=>e.update(r)),null===(t=this.character)||void 0===t||t.update(r),this.character&&this.character.mesh&&this.heatmapManager&&this.character.velocity.lengthSq()>1&&"thirdPerson"===this.movementMode&&this.heatmapManager.update(this.character.mesh.position),this.envHeatmapManager&&this.envHeatmapManager.update(r),this.currentController.update(r),this.updateListeners.forEach(e=>e(r)),e.f(C).stats.update(),this.postProcessing&&this.gtaoEnabled?this.postProcessing.render():e.f(C).renderer.render(this.scene,e.f(C).camera),m.InputManager.getInstance().update();}),this.scene=new s.Scene,this.controllers={fly:new i.FlyController(e.f(C).camera,e.f(C).renderer.domElement),orbit:new h.OrbitController(e.f(C).camera,e.f(C).renderer.domElement),thirdPerson:new d.ThirdPersonController(e.f(C).camera,e.f(C).renderer.domElement),topView:new l.TopViewController(e.f(C).camera,e.f(C).renderer.domElement)},this.currentController=this.controllers.fly;}}var P=new x;t.default=P;},"69939ce5":function e(e,t,i,s){e._m(t),e.o(t,"ThirdPersonController",()=>m);var r=i("09efd1d2"),o=e.w(i("3b16918b")),a=i("23b6b720"),n=i("f247f526"),l=i("0e70da6a"),h=i("9aaf3498"),c=i("96554b2f"),d=i("3eec3e47");class m{setDomElement(e){this.isActive&&this.domElement.removeEventListener("click",this.onClick),this.domElement=e,this.thirdPersonCamera.setDomElement(e),this.isActive&&this.domElement.addEventListener("click",this.onClick);}setCharacter(e){e.mesh&&this.setPlayerMesh(e.mesh),this.playerVelocity=e.velocity;}setPlayerMesh(e){this.playerMesh=e,this.thirdPersonCamera.setTarget(e);}setCollider(e){this.collider=e,this.thirdPersonCamera.setCollider(e);}enter(){this.isActive=!0,this.domElement.addEventListener("click",this.onClick),this.playerMesh&&this.thirdPersonCamera.syncWithCamera();var e=l.storeToRefs(n.useSceneStore()),t=e.moveSpeed,i=e.collisionEnabled;this.moveSpeed=t,this.collisionEnabled=i;}leave(){this.isActive=!1,this.domElement.removeEventListener("click",this.onClick),this.thirdPersonCamera.setLocked(!1),document.pointerLockElement===this.domElement&&document.exitPointerLock();}update(e){this.handleInput(e),this.updatePlayer(e),this.thirdPersonCamera.update(e),this.playerMesh&&c.doorManager.update(this.playerMesh.position);}dispose(){this.thirdPersonCamera.dispose();}onClick(){document.pointerLockElement||(this.domElement.requestPointerLock(),this.thirdPersonCamera.setLocked(!0));}handleInput(e){if(this.playerMesh){var t=d.InputManager.getInstance(),i=t.getMovementInput();if(t.isKeyDown("KeyF")&&c.doorManager.interact(),this.camera.getWorldDirection(this.tempForward),this.tempForward.y=0,this.tempForward.normalize(),this.tempRight.crossVectors(this.tempForward,this.camera.up).normalize(),this.playerDirection.set(0,0,0),this.playerDirection.addScaledVector(this.tempForward,i.z),this.playerDirection.addScaledVector(this.tempRight,i.x),this.playerDirection.lengthSq()>0){this.playerDirection.normalize(),this.playerVelocity.add(this.playerDirection.multiplyScalar(this.moveSpeed.value*e));var s=Math.atan2(this.playerDirection.x,this.playerDirection.z),r=new o.Quaternion;r.setFromAxisAngle(new o.Vector3(0,1,0),s),this.playerMesh.quaternion.slerp(r,.2);}}}updatePlayer(e){if(this.playerMesh){var t=Math.exp(-4*e)-1;this.playerVelocity.addScaledVector(this.playerVelocity,t);var i=this.playerVelocity.clone().multiplyScalar(e);this.collider&&this.collisionEnabled.value&&(this.resolveCollisions(i),c.doorManager.checkCollision(this.playerMesh.position,.15,i)),this.playerMesh.position.add(i);}}resolveCollisions(e){if(this.playerMesh&&this.collider){var t=new o.Vector3(0,.2,0),i=this.playerMesh.position.clone().add(t).add(e),s=this.collider.geometry.boundsTree;if(s){for(var r=new o.Vector3,a=0;a<5;a++)s.shapecast({intersectsBounds:e=>.15>e.distanceToPoint(i),intersectsTriangle:e=>{var t=e.closestPointToPoint(i,r).distanceTo(i);if(t<.15){var s=.15-t,o=i.clone().sub(r).normalize();o.y=0,i.addScaledVector(o,s);}}});var n=i.clone().sub(t);e.copy(n).sub(this.playerMesh.position);}}}setLocked(e){this.thirdPersonCamera.setLocked(e),e?this.domElement.requestPointerLock():document.pointerLockElement===this.domElement&&document.exitPointerLock();}constructor(e,t){r._(this,"camera",void 0),r._(this,"domElement",void 0),r._(this,"thirdPersonCamera",void 0),r._(this,"playerMesh",null),r._(this,"playerVelocity",new o.Vector3),r._(this,"playerDirection",new o.Vector3),r._(this,"tempForward",new o.Vector3),r._(this,"tempRight",new o.Vector3),r._(this,"collider",null),r._(this,"moveSpeed",h.ref(0)),r._(this,"collisionEnabled",h.ref(!0)),r._(this,"isActive",!1),this.camera=e,this.domElement=t,this.thirdPersonCamera=new a.ThirdPersonCamera(e,t),this.onClick=this.onClick.bind(this);}}},"71200ed9":function e(e,a,t,n){e._m(a),e.o(a,"useViewerSync",()=>r);var i=t("15edfc35"),l=t("9aaf3498"),o=t("0e70da6a"),s=t("f247f526"),v=e.i(t("26d7988f")),c=e.i(t("67dbd159")),f=e.w(t("3b16918b")),u=t("c2079dd8");function r(){var a=s.useSceneStore(),t=o.storeToRefs(a),n=t.cameraPosition,r=t.cameraDirection,d=t.isEditingPosition,h=t.isEditingDirection,m=t.movementMode,E=t.skyboxEnabled,p=t.showHeatmap,g=t.envHeatmapLayer,b=t.showCollisionBoxes,w=t.statsVisible,y=t.playerPosition,P=t.isEditingPlayerPosition,S=t.environmentEnabled,C=t.environmentIntensity,D=t.gtaoEnabled,x=t.gtaoSamples,M=t.gtaoDistanceExponent,V=t.gtaoDistanceFallOff,I=t.gtaoRadius,L=t.gtaoScale,O=t.gtaoThickness,k=t.gtaoAoOnly,A=t.sunEnabled,H=t.sunColor,z=t.sunIntensity,T=t.sunPosition,F=t.ambientEnabled,R=t.ambientColor,U=t.ambientIntensity,_=t.spotEnabled,q=t.spotColor,B=t.spotIntensity,G=t.spotAngle,j=t.spotPenumbra,J=t.spotDecay,K=t.spotDistance;l.watchEffect(()=>{if(d.value){var a=n.value,t=a.x,i=a.y,l=a.z;e.f(c).setCameraPosition(new f.Vector3(t,i,l));}}),l.watchEffect(()=>{if(h.value){var a=r.value,t=a.x,n=a.y,i=a.z,l=new f.Vector3(t,n,i);l.lengthSq()>0&&e.f(c).setCameraDirection(l);}}),l.watchEffect(()=>{var a;if(P.value&&(null===(a=e.f(c).character)||void 0===a?void 0:a.mesh)){var t=y.value,n=t.x,i=t.y,l=t.z;e.f(c).character.mesh.position.set(n,i,l);}}),l.watchEffect(()=>{e.f(c).setMovementMode(m.value);}),l.watchEffect(()=>{e.f(c).setSkyboxEnabled(E.value);}),l.watchEffect(()=>{e.f(c).setHeatmapVisible(p.value);}),l.watchEffect(()=>{e.f(c).setEnvHeatmapLayer(g.value);}),l.watchEffect(()=>{u.colliderManager.setVisibility(b.value);}),l.watchEffect(()=>{e.f(v).setStatsVisible(w.value);}),l.watchEffect(()=>{e.f(c).setEnvironmentEnabled(S.value);}),l.watchEffect(()=>{e.f(c).setEnvironmentIntensity(C.value);}),l.watchEffect(()=>{e.f(c).updateGTAO({enabled:D.value,samples:x.value,distanceExponent:M.value,distanceFallOff:V.value,radius:I.value,scale:L.value,thickness:O.value,aoOnly:k.value});}),l.watchEffect(()=>{var a;null===(a=e.f(c).lightManager)||void 0===a||a.updateSunLight(A.value,H.value,z.value,i._({},T.value));}),l.watchEffect(()=>{var a;null===(a=e.f(c).lightManager)||void 0===a||a.updateAmbientLight(F.value,R.value,U.value);}),l.watchEffect(()=>{var a;null===(a=e.f(c).lightManager)||void 0===a||a.updateSpotLight(_.value,q.value,B.value,G.value,j.value,J.value,K.value);});var N=e.f(c).onUpdate(()=>{var t;d.value||a.updateCameraPosition(e.f(v).camera.position),h.value||a.updateCameraDirection(e.f(c).getCameraDirection()),"thirdPerson"===m.value&&!P.value&&(null===(t=e.f(c).character)||void 0===t?void 0:t.mesh)&&a.updatePlayerPosition(e.f(c).character.mesh.position);});l.onUnmounted(()=>{N();});}},"7c3ee4ab":function e(e,t,a,l){e._m(t);var n=a("b5537c77");a("c550eeaa"),a("2d08c2e5"),a("a3876e70"),a("2554870f"),a("c98af605");var r=a("9aaf3498"),c=a("9aaf3498"),o=a("9aaf3498"),i=a("1f6a8afd"),u=a("0e70da6a"),d=a("f247f526"),v={class:"scene-tree-container"};t.default=r.defineComponent({__name:"SceneTreePanel",setup(e){var t=d.useSceneStore(),a=u.storeToRefs(t),l=a.modelRoot,r=a.movementMode,f=o.ref([]),h=o.ref([]),s=o.ref(4),p=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,l=t?"".concat(t,"-").concat(e.id):"".concat(e.id),n={key:l,label:e.name||"".concat(e.type," #").concat(e.id),object3D:e};return e.children.length>0&&a<s.value&&(n.children=e.children.map(e=>p(e,l,a+1))),n;},y=e=>{var t=[],a=e=>{var l=!0,n=!1,r=void 0;try{for(var c,o=e[Symbol.iterator]();!(l=(c=o.next()).done);l=!0){var i=c.value;t.push(i.key),i.children&&a(i.children);}}catch(e){n=!0,r=e;}finally{try{l||null==o.return||o.return();}finally{if(n)throw r;}}};return a(e),t;},m=()=>{if(l.value){var e=p(l.value);f.value=[e],h.value=y(f.value);}},x=(e,t,a)=>{var l=a.node;l&&(l.object3D.visible="check"===a.action),h.value=e;};return o.watch(l,e=>{e&&m();},{immediate:!0}),o.watch(s,()=>{m();}),o.watch(r,e=>{var t="topView"===e,a=function(e){var t=f.value,a=!0,l=!1,r=void 0;try{for(var c,o=e[Symbol.iterator]();!(a=(c=o.next()).done);a=!0){var i=function(){var a=c.value,l=t.find(e=>e.object3D.name===a);return l?a===e[e.length-1]?{v:l}:void(t=l.children||[]):{v:null};}();if("object"===n._(i))return i.v;}}catch(e){l=!0,r=e;}finally{try{a||null==o.return||o.return();}finally{if(l)throw r;}}return null;}(["Scene","Scene_Collection","Ceiling"]);a&&(a.object3D.visible=!t,t?h.value=h.value.filter(e=>e!==a.key):h.value.includes(a.key)||h.value.push(a.key));}),(e,t)=>(c.openBlock(),c.createElementBlock(c.Fragment,null,[c.createVNode(c.unref(i.NText),{depth:"3"},{default:c.withCtx(()=>[...t[1]||(t[1]=[c.createTextVNode("勾选/取消勾选以显示/隐藏模型层级中的对象。",-1)])]),_:1}),c.createVNode(c.unref(i.NSpace),{vertical:"",size:"small",style:{"margin-top":"12px","margin-bottom":"12px"}},{default:c.withCtx(()=>[c.createVNode(c.unref(i.NSpace),{justify:"space-between",style:{width:"100%"}},{default:c.withCtx(()=>[c.createVNode(c.unref(i.NText),{depth:"2",style:{"font-size":"12px"}},{default:c.withCtx(()=>[...t[2]||(t[2]=[c.createTextVNode("显示深度",-1)])]),_:1}),c.createVNode(c.unref(i.NText),null,{default:c.withCtx(()=>[c.createTextVNode(c.toDisplayString(s.value)+" 层",1)]),_:1})]),_:1}),c.createVNode(c.unref(i.NSlider),{value:s.value,"onUpdate:value":t[0]||(t[0]=e=>s.value=e),min:1,max:10,step:1},null,8,["value"])]),_:1}),c.createElementVNode("div",v,[c.createVNode(c.unref(i.NTree),{data:f.value,"checked-keys":h.value,"onUpdate:checkedKeys":x,checkable:"",selectable:"","block-line":"","expand-on-click":"","default-expand-all":"",style:{"font-size":"12px"}},null,8,["data","checked-keys"])])],64));}});},"96554b2f":function t(t,i,o,n){t._m(i),t.o(i,"Door",()=>s),t.o(i,"DoorManager",()=>c),t.o(i,"doorManager",()=>h);var e=o("09efd1d2");o("c550eeaa"),o("2d08c2e5"),o("a3876e70");var a=t.w(o("3b16918b")),r=o("f247f526");class s{get isAnimating(){return!!this.action&&this.action.isRunning();}interact(){this.action&&(this.isOpen=!this.isOpen,this.action.paused=!1,this.isOpen?this.action.timeScale=1:this.action.timeScale=-1,this.action.play());}getDistance(t){return this.object.getWorldPosition(this.worldPosition),this.worldPosition.distanceTo(t);}constructor(t,i,o){e._(this,"object",void 0),e._(this,"isOpen",!1),e._(this,"mixer",void 0),e._(this,"action",null),e._(this,"box",void 0),e._(this,"worldPosition",new a.Vector3),this.object=t,this.box=new a.Box3().setFromObject(t),this.mixer=o;var n=t.name+"Open",r=i.find(t=>t.name===n);r?(this.action=this.mixer.clipAction(r),this.action.loop=a.LoopOnce,this.action.clampWhenFinished=!0):console.warn("Animation ".concat(n," not found for door ").concat(t.name));}}class c{addDoor(t,i,o){if(!this.doors.find(i=>i.object===t)){var n=new s(t,i,o);this.doors.push(n);}}update(t){var i=null,o=1/0,n=!0,e=!1,a=void 0;try{for(var s,c=this.doors[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var h=s.value,l=h.getDistance(t);l<this.interactionDistance&&l<o&&(o=l,i=h);}}catch(t){e=!0,a=t;}finally{try{n||null==c.return||c.return();}finally{if(e)throw a;}}var x=r.useSceneStore();i?(this.activeDoor=i,x.showInteractionPrompt=!0,x.interactionText=i.isOpen?"按 F 关门":"按 F 开门"):(this.activeDoor=null,x.showInteractionPrompt=!1);}interact(){this.activeDoor&&this.activeDoor.interact();}checkCollision(t,i,o){var n=!0,e=!1,r=void 0;try{for(var s,c=this.doors[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var h=s.value;if(!h.isOpen&&!h.isAnimating){h.box.setFromObject(h.object);var l=new a.Box3,x=t.clone().add(o);if(l.min.set(x.x-i,x.y,x.z-i),l.max.set(x.x+i,x.y+2,x.z+i),h.box.intersectsBox(l)){var d=h.box.clone().intersect(l),m=d.max.x-d.min.x,v=d.max.z-d.min.z;m<v?x.x<h.box.min.x+(h.box.max.x-h.box.min.x)/2?o.x-=m:o.x+=m:x.z<h.box.min.z+(h.box.max.z-h.box.min.z)/2?o.z-=v:o.z+=v;}}}}catch(t){e=!0,r=t;}finally{try{n||null==c.return||c.return();}finally{if(e)throw r;}}}constructor(){e._(this,"doors",[]),e._(this,"interactionDistance",2),e._(this,"activeDoor",null);}}var h=new c;},"ae64a1a9":function s(s,i,t,e){s._m(i),s.o(i,"HeatmapManager",()=>h);var a=t("09efd1d2"),o=s.w(t("3b16918b")),r=t("16fd0772");class h{createDisplayMesh(s){var i=new o.PlaneGeometry(1,1);i.rotateX(-Math.PI/2),this.showTexture2Uniform=r.uniform(0);var t=this.params.flipV?r.uv().flipY():r.uv(),e=r.texture(this.storageTexture1).sample(t).r,a=r.texture(this.storageTexture2).sample(t).r,h=r.mix(e,a,this.showTexture2Uniform),n=r.float(this.params.displayGamma),m=r.pow(h.max(0),n),u=r.float(this.params.redBias),d=r.float(.05),l=r.smoothstep(u.sub(d),u.add(d),m),p=r.vec3(0,0,1),f=r.vec3(0,1,0),x=r.vec3(1,0,0),c=r.mix(p,f,m.mul(2).min(1)),v=r.mix(f,x,m.mul(2).sub(1).max(0)),y=r.mix(c,v,l),M=r.smoothstep(.02,.12,m).mul(.6),b=new o.MeshBasicNodeMaterial;b.colorNode=y,b.opacityNode=M,b.transparent=!0,b.side=o.DoubleSide,b.depthWrite=!1,b.polygonOffset=!0,b.polygonOffsetFactor=-1,this.displayMesh=new o.Mesh(i,b),this.displayMesh.position.y=.5,this.updateDisplayMeshTransform(),this.displayMesh.visible=!1,s.add(this.displayMesh);}update(s){this.characterPosUniform.value.copy(s),this.pingPong?(this.renderer.compute(this.computeNode2),this.showTexture2Uniform.value=0,this.pingPong=!1):(this.renderer.compute(this.computeNode1),this.showTexture2Uniform.value=1,this.pingPong=!0);}setVisible(s){this.displayMesh&&(this.displayMesh.visible=s);}setRenderer(s){this.renderer=s;}setXZBoundsFromBox3(s){var i=s.min,t=s.max;this.boundsMinUniform.value.set(i.x,i.z),this.boundsMaxUniform.value.set(t.x,t.z),this.updateDisplayMeshTransform();}updateDisplayMeshTransform(){if(this.displayMesh){var s=this.boundsMinUniform.value,i=this.boundsMaxUniform.value,t=i.x-s.x,e=i.y-s.y,a=(s.x+i.x)*.5,o=(s.y+i.y)*.5;this.displayMesh.scale.set(t,1,e),this.displayMesh.position.x=a,this.displayMesh.position.z=o;}}constructor(s){a._(this,"displayMesh",null),a._(this,"renderer",void 0),a._(this,"storageTexture1",void 0),a._(this,"storageTexture2",void 0),a._(this,"computeNode1",void 0),a._(this,"computeNode2",void 0),a._(this,"characterPosUniform",void 0),a._(this,"boundsMinUniform",void 0),a._(this,"boundsMaxUniform",void 0),a._(this,"pingPong",!1),a._(this,"showTexture2Uniform",void 0),a._(this,"params",{size:100,resolution:1024,brushRadius:1.5,intensity:.05,decay:1e-4,flipV:!0,displayGamma:2.2,redBias:.75}),this.renderer=s;var i=()=>{var s=new o.StorageTexture(this.params.resolution,this.params.resolution);return s.type=o.FloatType,s.format=o.RedFormat,s.minFilter=o.LinearFilter,s.magFilter=o.LinearFilter,s;};this.storageTexture1=i(),this.storageTexture2=i(),this.characterPosUniform=r.uniform(r.vec3(0)),this.boundsMinUniform=r.uniform(r.vec2(-this.params.size/2,-this.params.size/2)),this.boundsMaxUniform=r.uniform(r.vec2(this.params.size/2,this.params.size/2));var t=(s,i)=>r.Fn(()=>{var t=r.float(this.params.resolution),e=r.float(this.params.resolution),a=r.instanceIndex.mod(this.params.resolution),o=r.instanceIndex.div(this.params.resolution),h=r.uvec2(a,o),n=r.texture(s).load(h).r,m=a.toVar().toFloat().add(.5).div(t),u=o.toVar().toFloat().add(.5).div(e),d=r.mix(this.boundsMinUniform.x,this.boundsMaxUniform.x,m),l=r.mix(this.boundsMinUniform.y,this.boundsMaxUniform.y,u),p=r.vec2(d,l).distance(r.vec2(this.characterPosUniform.x,this.characterPosUniform.z)),f=r.float(this.params.decay),x=n.mul(r.float(1).sub(f)).toVar(),c=p.div(this.params.brushRadius),v=r.float(1).sub(c).max(0),y=v.mul(v).mul(r.float(3).sub(v.mul(2)));x.addAssign(y.mul(this.params.intensity));var M=x.min(1);r.textureStore(i,h,r.vec4(M,0,0,0));})().compute(this.params.resolution*this.params.resolution);this.computeNode1=t(this.storageTexture1,this.storageTexture2),this.computeNode2=t(this.storageTexture2,this.storageTexture1);}}},"bd4a3b48":function e(e,t,a,r){e._m(t);var l=a("9aaf3498"),c=a("9aaf3498"),i=a("9aaf3498"),n=a("1f6a8afd"),o=a("0e70da6a"),u=a("f247f526"),d={class:"circle-text"},s={class:"circle-text__value"},v={class:"circle-text__status"},m={class:"circle-text"},f={class:"circle-text__value"},p={class:"circle-text__status"},g={class:"circle-text"},N={class:"circle-text__value"},_={class:"circle-text__status"};t.default=l.defineComponent({__name:"EnvIndicators",setup(e){var t=u.useSceneStore(),a=o.storeToRefs(t),r=a.temperatureC,l=a.humidityRh,x=a.pm25Ug,h=a.temperatureComfort,V=a.humidityComfort,C=a.pm25Comfort,E=e=>Math.max(0,Math.min(1,e)),S=(e,t,a)=>a<=t?0:Math.round(100*E((e-t)/(a-t))),y=i.computed(()=>{var e=h.value,t=e.min,a=e.max;return r.value>=t&&r.value<=a;}),w=i.computed(()=>{var e=V.value,t=e.min,a=e.max;return l.value>=t&&l.value<=a;}),b=i.computed(()=>x.value<=C.value.max),D=i.computed(()=>S(r.value,10,35)),z=i.computed(()=>S(l.value,0,100)),M=i.computed(()=>S(x.value,0,200));return(e,t)=>(c.openBlock(),c.createBlock(c.unref(n.NCard),{class:"env-indicators",bordered:!1,size:"small"},{default:c.withCtx(()=>[c.createVNode(c.unref(n.NSpace),{vertical:"",size:"large",align:"center"},{default:c.withCtx(()=>[c.createVNode(c.unref(n.NSpace),{vertical:"",size:"small",align:"center"},{default:c.withCtx(()=>[c.createVNode(c.unref(n.NProgress),{type:"circle",percentage:D.value,color:"rgb(24, 160, 88)",",":"","rail-color":"rgba(24, 160, 88, 0.3)",height:76},{default:c.withCtx(()=>[c.createElementVNode("div",d,[t[0]||(t[0]=c.createElementVNode("div",null,"温度",-1)),c.createElementVNode("div",s,c.toDisplayString(c.unref(r))+"℃",1),c.createElementVNode("div",v,c.toDisplayString(y.value?"舒适":"不舒适"),1)])]),_:1},8,["percentage"])]),_:1}),c.createVNode(c.unref(n.NSpace),{vertical:"",size:"small",align:"center"},{default:c.withCtx(()=>[c.createVNode(c.unref(n.NProgress),{type:"circle",percentage:z.value,color:"rgb(32, 128, 240)","rail-color":"rgba(32, 128, 240, 0.3)",height:76},{default:c.withCtx(()=>[c.createElementVNode("div",m,[t[1]||(t[1]=c.createElementVNode("div",null,"湿度",-1)),c.createElementVNode("div",f,c.toDisplayString(c.unref(l))+"%",1),c.createElementVNode("div",p,c.toDisplayString(w.value?"舒适":"不舒适"),1)])]),_:1},8,["percentage"])]),_:1}),c.createVNode(c.unref(n.NSpace),{vertical:"",size:"small",align:"center"},{default:c.withCtx(()=>[c.createVNode(c.unref(n.NProgress),{type:"circle",percentage:M.value,color:"rgb(240, 160, 32)","rail-color":"rgba(240, 160, 32, 0.3)",height:76},{default:c.withCtx(()=>[c.createElementVNode("div",g,[t[2]||(t[2]=c.createElementVNode("div",null,"PM 2.5",-1)),c.createElementVNode("div",N,c.toDisplayString(c.unref(x)),1),c.createElementVNode("div",_,c.toDisplayString(b.value?"舒适":"不舒适"),1)])]),_:1},8,["percentage"])]),_:1})]),_:1})]),_:1}));}});},"f247f526":function e(e,r,f,a){e._m(r),e.o(r,"useSceneStore",()=>t),f("bf3a4d74"),f("db38ec0f");var n=f("0e70da6a"),F=f("9aaf3498"),o=(e,r)=>{r.x=parseFloat(e.x.toFixed(2)),r.y=parseFloat(e.y.toFixed(2)),r.z=parseFloat(e.z.toFixed(2));},t=n.defineStore("scene",()=>{var e=F.ref(!0),r=F.ref(0),f=F.ref(!0),a=F.ref(null),n=F.ref("fly"),t=F.ref(20),i=F.ref({x:1,y:1,z:1}),u=F.ref({x:0,y:0,z:-1}),l=F.ref(!1),d=F.ref(!1),x=F.ref({x:0,y:.1,z:0}),c=F.ref(!1),m=F.ref(!1),s=F.ref(!0),y=F.ref(!0),p=F.ref(!1),v=F.ref(""),z=F.ref(!0),P=F.ref(!1),S=F.ref(null),b=F.ref(23),C=F.ref(50),R=F.ref(12),k=F.ref({min:20,max:26}),w=F.ref({min:40,max:60}),D=F.ref({max:35}),I=F.ref(!0),M=F.ref("#FFFFFF"),_=F.ref(5),g=F.ref({x:10,y:20,z:-20}),h=F.ref(!1),j=F.ref("#FFFFFF"),q=F.ref(1),A=F.ref(!0),B=F.ref(1),E=F.ref(!1),G=F.ref(16),H=F.ref(2),J=F.ref(1),K=F.ref(.25),L=F.ref(1),N=F.ref(1),O=F.ref(!1),Q=F.ref(!1),T=F.ref("#FFFFFF"),U=F.ref(1),V=F.ref(30),W=F.ref(.3),X=F.ref(1),Y=F.ref(1e3);return{isLoading:e,loadingProgress:r,rendererInfo:F.ref(""),isDarkMode:f,modelRoot:a,movementMode:n,moveSpeed:t,cameraPosition:i,cameraDirection:u,isEditingPosition:l,isEditingDirection:d,playerPosition:x,isEditingPlayerPosition:c,showCollisionBoxes:m,collisionEnabled:s,statsVisible:y,showInteractionPrompt:p,interactionText:v,skyboxEnabled:z,showHeatmap:P,envHeatmapLayer:S,temperatureC:b,humidityRh:C,pm25Ug:R,temperatureComfort:k,humidityComfort:w,pm25Comfort:D,sunEnabled:I,sunColor:M,sunIntensity:_,sunPosition:g,ambientEnabled:h,ambientColor:j,ambientIntensity:q,environmentEnabled:A,environmentIntensity:B,gtaoEnabled:E,gtaoSamples:G,gtaoDistanceExponent:H,gtaoDistanceFallOff:J,gtaoRadius:K,gtaoScale:L,gtaoThickness:N,gtaoAoOnly:O,spotEnabled:Q,spotColor:T,spotIntensity:U,spotAngle:V,spotPenumbra:W,spotDecay:X,spotDistance:Y,setModelRoot:function(e){a.value=e?F.markRaw(e):null;},updateCameraPosition:function(e){o(e,i.value);},updateCameraDirection:function(e){o(e,u.value);},updatePlayerPosition:function(e){o(e,x.value);}};});},"f49f4847":function e(e,t,a,l){e._m(t),a("2d08c2e5"),a("a3876e70");var u=a("9aaf3498"),n=a("9aaf3498"),r=a("1f6a8afd"),i=a("0e70da6a"),d=a("f247f526"),o=e.i(a("c879eb01"));t.default=u.defineComponent({__name:"MovementPanel",setup(t){var a=d.useSceneStore(),l=i.storeToRefs(a),u=l.movementMode,f=l.moveSpeed,c=l.cameraPosition,N=l.cameraDirection,v=l.isEditingPosition,p=l.isEditingDirection,s=l.playerPosition,x=l.isEditingPlayerPosition,h=l.envHeatmapLayer,V=(e,t)=>{if(t){h.value=e;return;}h.value===e&&(h.value=null);},w=[{label:"飞行",value:"fly"},{label:"轨道",value:"orbit"},{label:"第三人称",value:"thirdPerson"},{label:"俯视",value:"topView"}];return(t,l)=>(n.openBlock(),n.createBlock(n.unref(r.NSpace),{vertical:"",size:"large"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"2",style:{"font-size":"12px"}},{default:n.withCtx(()=>[...l[12]||(l[12]=[n.createTextVNode("移动方式",-1)])]),_:1}),n.createVNode(n.unref(r.NSelect),{value:n.unref(u),"onUpdate:value":l[0]||(l[0]=e=>n.isRef(u)?u.value=e:null),options:w},null,8,["value"])]),_:1}),"topView"===n.unref(u)?(n.openBlock(),n.createBlock(n.unref(r.NSpace),{key:0,vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"2",style:{"font-size":"12px"}},{default:n.withCtx(()=>[...l[13]||(l[13]=[n.createTextVNode("俯视图设置",-1)])]),_:1}),n.createVNode(n.unref(r.NSpace),{align:"center"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSwitch),{value:n.unref(a).showHeatmap,"onUpdate:value":l[1]||(l[1]=e=>n.unref(a).showHeatmap=e)},null,8,["value"]),n.createVNode(n.unref(r.NText),null,{default:n.withCtx(()=>[...l[14]||(l[14]=[n.createTextVNode("足迹热力图",-1)])]),_:1})]),_:1}),n.createVNode(n.unref(r.NSpace),{align:"center"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSwitch),{value:"temperature"===n.unref(h),"onUpdate:value":l[2]||(l[2]=e=>V("temperature",e))},null,8,["value"]),n.createVNode(n.unref(r.NText),null,{default:n.withCtx(()=>[...l[15]||(l[15]=[n.createTextVNode("温度",-1)])]),_:1})]),_:1}),n.createVNode(n.unref(r.NSpace),{align:"center"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSwitch),{value:"humidity"===n.unref(h),"onUpdate:value":l[3]||(l[3]=e=>V("humidity",e))},null,8,["value"]),n.createVNode(n.unref(r.NText),null,{default:n.withCtx(()=>[...l[16]||(l[16]=[n.createTextVNode("湿度",-1)])]),_:1})]),_:1}),n.createVNode(n.unref(r.NSpace),{align:"center"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSwitch),{value:"pm25"===n.unref(h),"onUpdate:value":l[4]||(l[4]=e=>V("pm25",e))},null,8,["value"]),n.createVNode(n.unref(r.NText),null,{default:n.withCtx(()=>[...l[17]||(l[17]=[n.createTextVNode("PM2.5",-1)])]),_:1})]),_:1})]),_:1})):n.createCommentVNode("",!0),n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NSpace),{justify:"space-between",style:{width:"100%"}},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"2",style:{"font-size":"12px"}},{default:n.withCtx(()=>[...l[18]||(l[18]=[n.createTextVNode("移动速度",-1)])]),_:1}),n.createVNode(n.unref(r.NText),null,{default:n.withCtx(()=>[n.createTextVNode(n.toDisplayString(Math.round(n.unref(f)))+" u/s",1)]),_:1})]),_:1}),n.createVNode(n.unref(r.NSlider),{value:n.unref(f),"onUpdate:value":l[5]||(l[5]=e=>n.isRef(f)?f.value=e:null),min:1,max:50,step:1},null,8,["value"])]),_:1}),n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"2",style:{"font-weight":"600"}},{default:n.withCtx(()=>[...l[19]||(l[19]=[n.createTextVNode("摄像机位置",-1)])]),_:1}),n.createVNode(e.f(o),{value:n.unref(c),"onUpdate:value":l[6]||(l[6]=e=>n.isRef(c)?c.value=e:null),editing:n.unref(v),"onUpdate:editing":l[7]||(l[7]=e=>n.isRef(v)?v.value=e:null)},null,8,["value","editing"])]),_:1}),"thirdPerson"===n.unref(u)?(n.openBlock(),n.createBlock(n.unref(r.NSpace),{key:1,vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"2",style:{"font-weight":"600"}},{default:n.withCtx(()=>[...l[20]||(l[20]=[n.createTextVNode("玩家位置",-1)])]),_:1}),n.createVNode(e.f(o),{value:n.unref(s),"onUpdate:value":l[8]||(l[8]=e=>n.isRef(s)?s.value=e:null),editing:n.unref(x),"onUpdate:editing":l[9]||(l[9]=e=>n.isRef(x)?x.value=e:null)},null,8,["value","editing"])]),_:1})):n.createCommentVNode("",!0),n.createVNode(n.unref(r.NSpace),{vertical:"",size:"small"},{default:n.withCtx(()=>[n.createVNode(n.unref(r.NText),{depth:"2",style:{"font-weight":"600"}},{default:n.withCtx(()=>[...l[21]||(l[21]=[n.createTextVNode("摄像机方向",-1)])]),_:1}),n.createVNode(e.f(o),{value:n.unref(N),"onUpdate:value":l[10]||(l[10]=e=>n.isRef(N)?N.value=e:null),editing:n.unref(p),"onUpdate:editing":l[11]||(l[11]=e=>n.isRef(p)?p.value=e:null)},null,8,["value","editing"])]),_:1})]),_:1}));}});},});
//# sourceMappingURL=index_8b8d.33d7f491.js.map